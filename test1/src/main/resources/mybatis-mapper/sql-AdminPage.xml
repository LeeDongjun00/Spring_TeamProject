<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.test1.mapper.AdminMapper">
	<!--신고된 게시글 및 댓글 정보 가져오기-->
	<select id="getReportedBoardComment" resultType="com.example.test1.model.MainBoard">
        SELECT
        	REPORTNUM, 
        	REPORT_TYPE, 
        	REPORTED_USER_ID,
        	CONTENT, 
        	T.BOARDNO AS BOARDNO, 
        	T.COMMENTNO AS COMMENTNO, 
        	REPORT_CNT, 
        	REPORT_USER_ID, 
        	TITLE, 
        	BOARDUSER, 
        	BOARDCONTENTS, 
        	COMMENTUSER, 
        	COMMENTCONTENTS, 
        	STATUS, 
        	DELETED_YN
		FROM REPORT R
		LEFT JOIN (
			SELECT 
				B.BOARDNO AS BOARDNO, TITLE, B.USER_ID AS BOARDUSER, B.CONTENTS AS BOARDCONTENTS,
				COMMENTNO AS COMMENTNO, C.USER_ID AS COMMENTUSER, C.CONTENTS AS COMMENTCONTENTS
			FROM TBL_BOARD B
			LEFT JOIN(
				SELECT *
				FROM TBL_COMMENT
			)C ON B.BOARDNO = C.BOARDNO
		)T ON R.BOARDNO = T.BOARDNO OR R.COMMENTNO = T.COMMENTNO
		LEFT JOIN (
		    SELECT USER_ID, STATUS, DELETED_YN
		    FROM USERS
		)U ON R.REPORTED_USER_ID = U.USER_ID
		WHERE R.BOARDNO = #{boardNo} OR R.COMMENTNO = #{commentNo}
		
    </select>
    <!--신고 처리 완료-->
    <update id="updateProcessY" parameterType="hashmap">
    	UPDATE REPORT
	    SET REPORT_PROCESS = 'Y'
	    WHERE REPORTNUM = #{reportNum} 
    </update>
    <!--유저밴-->
    <update id="userBan" parameterType="hashmap">
    	UPDATE USERS
	    SET STATUS = 'B'
	    WHERE USER_ID = #{userId} 
    </update>

    <!-- 문의 게시판 글 조회 -->
    <select id="selectInquiryBoards" resultType="com.example.test1.model.MainBoard">
        SELECT 
            BOARDNO, 
            USER_ID, 
            TITLE, 
            CONTENTS, 
            FAV, 
            CNT, 
            CDATETIME, 
            UDATETIME, 
            TYPE, 
            REPORT_CNT
        FROM TBL_BOARD
        WHERE TYPE = 'SQ'
        ORDER BY CDATETIME DESC
    </select>
    <!--문의 게시판 댓글-->
    
    <insert id="insertComment" parameterType="com.example.test1.model.MainBoard">
    INSERT INTO TBL_COMMENT (
        COMMENTNO, BOARDNO, USER_ID, ORG_CMTNO, CONTENTS, ADOPT, CDATETIME, UDATETIME, NICKNAME
    ) VALUES (
        COMMENT_SEQ.NEXTVAL,
        #{boardNo},
        #{userId},
        NULL,
        #{contents},
        #{adopt},
        SYSDATE,
        SYSDATE,
        #{nickname, jdbcType=VARCHAR}
    )
	</insert>
	<!--댓글보기-->
	<select id="selectCommentsByBoardNo" resultType="com.example.test1.model.MainBoard">
	    SELECT 
	        COMMENTNO,
	        BOARDNO,
	        USER_ID,
	        ORG_CMTNO,
	        CONTENTS,
	        ADOPT,
	        TO_CHAR(CDATETIME, 'YYYY-MM-DD HH24:MI') AS CDATETIME,
	        TO_CHAR(UDATETIME, 'YYYY-MM-DD HH24:MI') AS UDATETIME,  
	        NICKNAME
	    FROM TBL_COMMENT
	    WHERE BOARDNO = #{boardNo}
	    ORDER BY CDATETIME ASC
	</select>


	<delete id="deleteComment" parameterType="hashmap">
	    DELETE FROM TBL_COMMENT
	    WHERE COMMENTNO = #{commentNo}
	</delete>
	
	<update id="updateUserStatus" parameterType="hashmap">
	    UPDATE USERS
	    SET STATUS = 'B',
	        UDATETIME = SYSDATE
	    WHERE USER_ID = #{userId}
	</update>
	
	<select id="selectBadUsers" resultType="hashmap">
	    SELECT USER_ID AS userId, NAME AS name, STATUS AS status
	    FROM USERS
	    WHERE STATUS = 'B'
	</select>

	<update id="changeUserStatus">
	    UPDATE USERS
	    SET STATUS = #{status}
	    WHERE USER_ID = #{userId}
	</update>

	<!--신고목록 가져오기-->
	<select id="selectReportList" resultType="hashmap">
	    SELECT 
	        R.REPORTNUM,
	        R.REPORT_TYPE,
	        R.REPORTED_USER_ID,
	        R.CONTENT,
	        R.BOARDNO AS BOARDNO1,
	        C.BOARDNO AS BOARDNO2,
	        R.COMMENTNO,
	        U.NICKNAME AS REPORTED_NICKNAME,  -- ✅ 유저 닉네임 추가
	        U.STATUS AS REPORTED_STATUS,      -- ✅ 유저 상태 추가 (선택)
	        R.REPORT_USER_ID,
	        STATUS,
	        DELETED_YN,
	        REPORT_PROCESS
	    FROM REPORT R
	    LEFT JOIN USERS U ON R.REPORTED_USER_ID = U.USER_ID
	    LEFT JOIN TBL_COMMENT C ON R.COMMENTNO = C.COMMENTNO
	    WHERE 1 = 1
	    <if test="processedFilter != null and processedFilter != 'all'">
		  <choose>
		    <when test="processedFilter == 'processed'">
		      AND REPORT_PROCESS = 'Y'
		    </when>
		    <when test="processedFilter == 'unprocessed'">
		      AND REPORT_PROCESS = 'N'
		    </when>
		  </choose>
		</if>
	    ORDER BY R.REPORTNUM DESC
	    OFFSET #{offset} ROWS FETCH NEXT #{pageSize} ROWS ONLY
	</select>
	
	<select id="selectAllReportCnt" resultType="int">
	  SELECT COUNT(*)
	  FROM REPORT R
	  WHERE 1 = 1
	    <if test="processedFilter != null and processedFilter != 'all'">
		  <choose>
		    <when test="processedFilter == 'processed'">
		      AND REPORT_PROCESS = 'Y'
		    </when>
		    <when test="processedFilter == 'unprocessed'">
		      AND REPORT_PROCESS = 'N'
		    </when>
		  </choose>
		</if>
	 
	</select>
	
	<select id="selectUserCnt" resultType="int">
	<!--사용자 총 수-->
	  SELECT 
	    COUNT(*)
	  FROM USERS
	</select>
	<select id="selectReportNPCnt" resultType="int">
	<!--미처리 신고 수-->
		SELECT COUNT(*)
		FROM REPORT
		WHERE REPORT_PROCESS = 'N'
	</select>
	<select id="selectInquiryNPCnt" resultType="int">
	<!--미답변 문의 수-->
	SELECT COUNT(*) AS TOTAL_CNT
	FROM (
	    SELECT B.BOARDNO, COUNT(COMMENTNO)AS CNT
	    FROM TBL_BOARD B
	    LEFT JOIN TBL_COMMENT C
	      ON B.BOARDNO = C.BOARDNO
	    WHERE B.TYPE = 'SQ'
	    GROUP BY B.BOARDNO
	    HAVING COUNT(C.COMMENTNO) = 0
	    ORDER BY B.BOARDNO
	)
	</select>




    <!-- 내 게시글 조회 -->
	<select id="selectMyPosts" resultType="hashMap">
	    SELECT 
	        B.BOARDNO,
	        B.USER_ID,
	        B.TITLE,
	        DBMS_LOB.SUBSTR(B.CONTENTS, 2000, 1) AS CONTENTS,
	        B.TYPE,
	        TO_CHAR(B.CDATETIME, 'YYYY-MM-DD') AS CDATETIME,
	        (
	            SELECT COUNT(*) 
	            FROM TBL_COMMENT C 
	            WHERE C.BOARDNO = B.BOARDNO
	        ) AS COMMENT_COUNT
	    FROM TBL_BOARD B
	    INNER JOIN USERS U ON B.USER_ID = U.USER_ID 
	    WHERE B.USER_ID = #{userId}
	    <if test="boardType == 'N'">
	        AND U.STATUS = 'A' <!--공지 게시판일 때만 조건 적용 -->
	    </if>
	    ORDER BY B.CDATETIME DESC
	</select>




	<!-- 내 댓글 조회 + 게시글 정보 포함 -->
	<select id="selectMyComments" resultType="hashMap">
	SELECT 
	    C.COMMENTNO,
	    C.USER_ID,
	    C.BOARDNO, 
	    C.CONTENTS AS COMMENT_CONTENT,
	    TO_CHAR(C.CDATETIME, 'YYYY-MM-DD') AS CDATETIME,
	    B.TITLE AS BOARD_TITLE,
	    DBMS_LOB.SUBSTR(B.CONTENTS, 4000, 1) AS BOARD_CONTENTS,
	    B.TYPE AS BOARD_TYPE  
	FROM TBL_COMMENT C
	JOIN TBL_BOARD B ON C.BOARDNO = B.BOARDNO
	WHERE C.USER_ID = #{userId}
	ORDER BY C.CDATETIME DESC
	</select>


	<!-- 게시글 삭제 -->
	<delete id="deletePost">
	    DELETE FROM TBL_BOARD
	    WHERE BOARDNO = #{boardNo}
	</delete>
	
	<!-- 댓글 삭제 -->
	  <delete id="deleteCommentById" parameterType="String">
	    DELETE FROM TBL_COMMENT
	    WHERE COMMENTNO = #{commentNo}
	  </delete>
	
	<!-- 댓글 수정 -->
	<update id="updateComment">
	    UPDATE TBL_COMMENT
	    SET 
	        CONTENTS = #{contents},
	        UDATETIME = SYSDATE
	    WHERE COMMENTNO = #{commentNo}
	</update>
 
	
	<!-- 게시글 수정 -->
	<update id="updatePost">
	    UPDATE TBL_BOARD
	    SET 
	        TITLE = #{title},
	        CONTENTS = #{contents},
	        UDATETIME = SYSDATE
	    WHERE BOARDNO = #{boardNo}
	</update>

	<!--신고된 게시글 번호-->
	<select id="selectBoardDetail" resultType="hashmap">
	    SELECT 
	        BOARDNO,
	        TITLE,
	        TO_CHAR(CONTENTS) AS CONTENTS, 
	        USER_ID,
	        CDATETIME,
	        TYPE,
	        CNT,
	        FAV
	    FROM TBL_BOARD
	    WHERE BOARDNO = #{boardNo}
	</select>

	<select id="selectByBoardNo" resultType="com.example.test1.model.MainBoard">
	    SELECT 
	        C.COMMENTNO,
	        C.BOARDNO,
	        C.USER_ID,
	        C.CONTENTS,
	        C.CDATETIME,
	        U.NICKNAME
	    FROM TBL_COMMENT C
	    LEFT JOIN USERS U ON C.USER_ID = U.USER_ID
	    WHERE C.BOARDNO = #{boardNo}
	    ORDER BY C.CDATETIME ASC
	</select>

	<select id="selectUserStatus" resultType="String">
	    SELECT STATUS FROM USERS WHERE USER_ID = #{userId}
	</select>
	
	
	<update id="updateUserStatusDirect" parameterType="hashmap">
	    UPDATE USERS
	    SET STATUS = #{status, jdbcType=CHAR},
	        UDATETIME = SYSDATE
	    WHERE USER_ID = #{userId, jdbcType=VARCHAR}  <!-- ✅ 수정됨 -->
	</update>



	
	
	<select id="selectAllUsers" resultType="hashmap">
	  SELECT 
	    U.*, TO_CHAR(U.CDATETIME,'YYYY-MM-DD') CDATE , TO_CHAR(U.DELETED_AT,'YYYY-MM-DD') DTIME , TO_CHAR(U.END_SUBS,'YYYY-MM-DD') SDATE
	  FROM USERS U
	  WHERE 1=1
	  	<if test="searchOption == 'USER_ID'">
			AND USER_ID LIKE '%' || #{keyword} || '%' 
		</if>
		<if test="searchOption == 'EMAIL'">
			AND EMAIL LIKE '%' || #{keyword} || '%' 
		</if>
		<if test="searchOption == 'NAME'">
			AND NAME LIKE '%' || #{keyword} || '%' 
		</if>
	  ORDER BY CDATETIME DESC, USER_ID DESC
	  OFFSET #{page} ROWS FETCH NEXT #{pageSize} ROWS ONLY
	</select>
	
	<select id="selectAllUsersCnt" resultType="int">
	  SELECT 
	    COUNT(*)
	  FROM USERS U
	  WHERE 1=1
	  	<if test="searchOption == 'USER_ID'">
			AND USER_ID LIKE '%' || #{keyword} || '%' 
		</if>
		<if test="searchOption == 'EMAIL'">
			AND EMAIL LIKE '%' || #{keyword} || '%' 
		</if>
		<if test="searchOption == 'NAME'">
			AND NAME LIKE '%' || #{keyword} || '%' 
		</if>
	 
	</select>
	
	<select id="getTopThemes" resultType="hashmap">
	  <![CDATA[
		  WITH THEM_STATS AS (
		    SELECT
		        TO_CHAR(RDATETIME,'YYYY-MM') AS MONTH,
		        TRIM(REGEXP_SUBSTR(THEMNUM,'[^,]+', 1, LEVEL)) AS THEME,
		        COUNT(*) AS THEMECNT,
		        SUM(PRICE) AS TOTAL_AMOUNT
		    FROM
		        RESERVATION
		    CONNECT BY 
		        REGEXP_SUBSTR(THEMNUM,'[^,]+', 1, LEVEL) IS NOT NULL
		        AND PRIOR RES_NUM = RES_NUM
		        AND PRIOR SYS_GUID() IS NOT NULL
		    GROUP BY
		        TO_CHAR(RDATETIME,'YYYY-MM'),
		        TRIM(REGEXP_SUBSTR(THEMNUM,'[^,]+', 1, LEVEL))
		)
		SELECT *
		FROM (
		    SELECT 
		        MONTH,
		        THEME,
		        THEMECNT,  -- 수정
		        TOTAL_AMOUNT,
		        ROW_NUMBER() OVER (PARTITION BY MONTH ORDER BY THEMECNT DESC) AS RN
		    FROM THEM_STATS
		)
		WHERE RN <= 3
		ORDER BY MONTH, THEMECNT DESC

	  ]]>
	</select>
	
	<update id="resetLoginCnt">
	    UPDATE USERS
	    SET 
	        CNT = 0
	    WHERE USER_ID = #{userId}
	</update>


</mapper>